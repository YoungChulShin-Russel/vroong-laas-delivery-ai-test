# ë°°ì†¡ ìƒì„± ê¸°ëŠ¥ ê°œë°œ ê³„íš

## ğŸ“‹ ìš”êµ¬ì‚¬í•­ ë¶„ì„

### ë°°ê²½
- ë°°ì°¨ì„œë²„ì—ì„œ ë°œí–‰í•œ ì¹´í”„ì¹´ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í•´ì„œ ë°°ì†¡ì„ ì‹œì‘í•˜ëŠ” ê¸°ëŠ¥ ê°œë°œ
- ì¹´í”„ì¹´ ì´ë²¤íŠ¸ ì •ë³´ëŠ” ì•„ì§ ë¯¸ì •ì´ë¯€ë¡œ ë”ë¯¸ë¡œ êµ¬í˜„ í›„ ì¶”í›„ êµ¬ì²´í™”

### í•µì‹¬ ê¸°ëŠ¥
1. **ì¹´í”„ì¹´ ì´ë²¤íŠ¸ ìˆ˜ì‹ **: `dispatch.event` í† í”½ì—ì„œ ë°°ì°¨ ì™„ë£Œ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
2. **ë°°ì†¡ ìƒì„±**: ìˆ˜ì‹ í•œ ì´ë²¤íŠ¸ë¡œ ë°°ì†¡(Delivery) ìƒì„±
3. **ì•ˆì‹¬ë²ˆí˜¸ ìƒì„±**: í†µì‹ ì‚¬ í˜¸ì¶œí•˜ì—¬ ì•ˆì‹¬ë²ˆí˜¸ ìƒì„± (í˜„ì¬ëŠ” ë”ë¯¸ êµ¬í˜„)
4. **ë°°ì†¡ ì •ì±… ì¡°íšŒ**: ì£¼ë¬¸ ì„œë²„ í˜¸ì¶œí•˜ì—¬ ë°°ì†¡ ì •ì±… ì¡°íšŒ (í˜„ì¬ëŠ” ë”ë¯¸ êµ¬í˜„)

## ğŸ—ï¸ ì•„í‚¤í…ì²˜ ì„¤ê³„

### ë ˆì´ì–´ë³„ ì±…ì„
```
Kafka Consumer (Interface Layer)
  â†’ DeliveryFacade (Application Layer)
    â†’ DeliveryCreator (Domain Service)
      â†’ DeliveryRepository (Port)
        â†’ DeliveryRepositoryAdapter (Infrastructure Layer)
```

### ë„ë©”ì¸ ëª¨ë¸
- **Delivery**: ë°°ì†¡ Aggregate Root
- **DeliveryNumber**: ë°°ì†¡ë²ˆí˜¸ (DEL-YYMMDDHHMMSS + ëœë¤ 3ìë¦¬)
- **DeliveryStatus**: ë°°ì†¡ìƒíƒœ (STARTED, ARRIVED, PICKED_UP, COMPLETED, CANCELLED)
- **DeliverySafePhoneNumber**: ì•ˆì‹¬ë²ˆí˜¸
- **DeliveryStatusHistory**: ìƒíƒœ ì´ë ¥
- **DeliveryPhoto**: ë°°ì†¡ ì‚¬ì§„
- **DeliveryPolicy**: ë°°ì†¡ ì •ì±…

## ğŸ“ ìƒì„±í•  íŒŒì¼

### Domain Layer (core/domain/delivery/)
```
core/domain/delivery/
â”œâ”€â”€ Delivery.java                          # Aggregate Root
â”œâ”€â”€ DeliveryNumber.java                    # Value Object
â”œâ”€â”€ DeliveryStatus.java                    # Enum
â”œâ”€â”€ DeliveryCreator.java                   # Domain Service (ìƒì„±)
â”œâ”€â”€ DeliveryReader.java                    # Domain Service (ì¡°íšŒ)
â”œâ”€â”€ CreateDeliveryCommand.java             # Command
â”œâ”€â”€ DeliveryCreatedEvent.java              # Domain Event
â”œâ”€â”€ exception/
â”‚   â”œâ”€â”€ DeliveryNotFoundException.java
â”‚   â””â”€â”€ InvalidDeliveryException.java
â””â”€â”€ required/
    â””â”€â”€ DeliveryRepository.java            # Port
```

### Application Layer (core/application/delivery/)
```
core/application/delivery/
â””â”€â”€ DeliveryFacade.java                    # Facade
```

### Infrastructure Layer (infrastructure/)
```
infrastructure/
â”œâ”€â”€ storage/db/delivery/
â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â”œâ”€â”€ DeliveryEntity.java
â”‚   â”‚   â”œâ”€â”€ DeliverySafePhoneNumberEntity.java
â”‚   â”‚   â”œâ”€â”€ DeliveryStatusHistoryEntity.java
â”‚   â”‚   â”œâ”€â”€ DeliveryPhotoEntity.java
â”‚   â”‚   â””â”€â”€ DeliveryPolicyEntity.java
â”‚   â””â”€â”€ adapter/
â”‚       â””â”€â”€ DeliveryRepositoryAdapter.java
â”œâ”€â”€ external/
â”‚   â”œâ”€â”€ client/
â”‚   â”‚   â”œâ”€â”€ AgentFeignClient.java          # ê¸°ì‚¬ ì„œë²„ (ë”ë¯¸)
â”‚   â”‚   â””â”€â”€ OrderFeignClient.java          # ì£¼ë¬¸ ì„œë²„ (ë”ë¯¸)
â”‚   â””â”€â”€ adapter/
â”‚       â”œâ”€â”€ AgentAdapter.java              # ë”ë¯¸
â”‚       â””â”€â”€ OrderAdapter.java              # ë”ë¯¸
â””â”€â”€ messaging/
    â””â”€â”€ consumer/
        â””â”€â”€ DispatchCompletedEventConsumer.java  # Kafka Consumer
```

### Interface Layer (api/)
```
api/web/delivery/
â”œâ”€â”€ DeliveryController.java
â””â”€â”€ dto/
    â”œâ”€â”€ request/
    â”‚   â””â”€â”€ CreateDeliveryRequest.java
    â””â”€â”€ response/
        â””â”€â”€ DeliveryResponse.java
```

## ğŸ”§ ì‘ì—… ë‚´ìš©

### 1ë‹¨ê³„: Domain Layer êµ¬í˜„
- **Delivery Aggregate Root**: í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
- **Value Objects**: DeliveryNumber, DeliveryStatus
- **Domain Services**: DeliveryCreator, DeliveryReader
- **Commands & Events**: CreateDeliveryCommand, DeliveryCreatedEvent
- **Ports**: DeliveryRepository ì¸í„°í˜ì´ìŠ¤

### 2ë‹¨ê³„: Application Layer êµ¬í˜„
- **DeliveryFacade**: íë¦„ ì¡°ì • (Domain Service í˜¸ì¶œ)

### 3ë‹¨ê³„: Infrastructure Layer êµ¬í˜„
- **JPA Entity**: Domain â†” Entity ë§¤í•‘
- **Repository Adapter**: DeliveryRepository êµ¬í˜„
- **ì™¸ë¶€ API Adapter**: ê¸°ì‚¬ ì„œë²„, ì£¼ë¬¸ ì„œë²„ (ë”ë¯¸)
- **Kafka Consumer**: dispatch.event í† í”½ ìˆ˜ì‹ 

### 4ë‹¨ê³„: Interface Layer êµ¬í˜„
- **Controller**: HTTP API
- **DTO**: Request/Response ë³€í™˜

## ğŸ¯ í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

### ë°°ì†¡ ìƒì„± íë¦„
1. **ì¹´í”„ì¹´ ì´ë²¤íŠ¸ ìˆ˜ì‹ **: `dispatch.event` í† í”½ì—ì„œ ë°°ì°¨ ì™„ë£Œ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
2. **ë°°ì†¡ ì •ì±… ì¡°íšŒ**: ì£¼ë¬¸ ì„œë²„ í˜¸ì¶œ (ë”ë¯¸)
3. **ê¸°ì‚¬ ì •ë³´ ì¡°íšŒ**: ê¸°ì‚¬ ì„œë²„ í˜¸ì¶œ (ë”ë¯¸)
4. **ì•ˆì‹¬ë²ˆí˜¸ ìƒì„±**: í†µì‹ ì‚¬ í˜¸ì¶œ (ë”ë¯¸)
5. **ë°°ì†¡ ìƒì„±**: Delivery Aggregate ìƒì„±
6. **ìƒíƒœ ì´ë ¥ ê¸°ë¡**: STARTED ìƒíƒœë¡œ ì´ˆê¸°í™”
7. **ë„ë©”ì¸ ì´ë²¤íŠ¸ ë°œí–‰**: DeliveryCreatedEvent

### ë°°ì†¡ë²ˆí˜¸ ìƒì„± ê·œì¹™
- **í˜•ì‹**: `DEL-YYMMDDHHMMSS` + ëœë¤ 3ìë¦¬
- **ì˜ˆì‹œ**: `DEL-250112143000123`

### ìƒíƒœ ì „ì´
```
ì •ìƒ ì§„í–‰:
STARTED â†’ ARRIVED â†’ PICKED_UP â†’ COMPLETED

ì·¨ì†Œ:
STARTED â†’ CANCELLED
ARRIVED â†’ CANCELLED
```

## ğŸ”„ ì™¸ë¶€ ì‹œìŠ¤í…œ ì—°ë™ (ë”ë¯¸)

### ê¸°ì‚¬ ì„œë²„ API (ë”ë¯¸)
```java
// TODO: ì‹¤ì œ ê¸°ì‚¬ ì„œë²„ API ì—°ë™
// GET /api/v1/agents/{agentId}
// Response: { agentId, phoneNumber, name }
```

### ì£¼ë¬¸ ì„œë²„ API (ë”ë¯¸)
```java
// TODO: ì‹¤ì œ ì£¼ë¬¸ ì„œë²„ API ì—°ë™
// GET /api/v1/orders/{orderId}/delivery-policy
// Response: { alcoholDelivery, contactlessDelivery, pickupRequestTime }
```

### í†µì‹ ì‚¬ API (ë”ë¯¸)
```java
// TODO: ì‹¤ì œ í†µì‹ ì‚¬ API ì—°ë™
// POST /api/v1/safe-phone-numbers
// Request: { originalPhoneNumber }
// Response: { safePhoneNumber, expiresAt }
```

## ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„

### ì£¼ìš” í…Œì´ë¸”
- **DELIVERY**: ë°°ì†¡ ë©”ì¸ ì •ë³´
- **DELIVERY_SAFE_PHONE_NUMBER**: ì•ˆì‹¬ë²ˆí˜¸ ê´€ë¦¬
- **DELIVERY_STATUS_HISTORY**: ìƒíƒœ ë³€ê²½ ì´ë ¥
- **DELIVERY_PHOTO**: ë°°ì†¡ ì‚¬ì§„
- **DELIVERY_POLICY**: ë°°ì†¡ ì •ì±…

### ì¸ë±ìŠ¤ ì „ëµ
- `delivery_number` (UNIQUE)
- `order_id` (ì¡°íšŒìš©)
- `agent_id` (ì¡°íšŒìš©)
- `status` (ìƒíƒœë³„ ì¡°íšŒ)

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì „ëµ

### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- **Domain Layer**: ìˆœìˆ˜ Java í…ŒìŠ¤íŠ¸ (Spring Context ì—†ìŒ)
- **Application Layer**: Mockì„ í™œìš©í•œ UseCase í…ŒìŠ¤íŠ¸
- **Infrastructure Layer**: @DataJpaTest í™œìš©
- **Interface Layer**: @WebMvcTest í™œìš©

### í†µí•© í…ŒìŠ¤íŠ¸
- **Kafka Consumer**: ì‹¤ì œ ì¹´í”„ì¹´ ì—°ë™ í…ŒìŠ¤íŠ¸
- **ì™¸ë¶€ API**: WireMock í™œìš©í•œ API ëª¨í‚¹

## ğŸ“ êµ¬í˜„ ìˆœì„œ

### 1ì£¼ì°¨: Domain Layer
- [ ] Delivery Aggregate Root
- [ ] Value Objects
- [ ] Domain Services
- [ ] Commands & Events
- [ ] Repository Port

### 2ì£¼ì°¨: Application & Infrastructure
- [ ] DeliveryFacade
- [ ] JPA Entity ë§¤í•‘
- [ ] Repository Adapter
- [ ] ì™¸ë¶€ API Adapter (ë”ë¯¸)

### 3ì£¼ì°¨: Interface & Integration
- [ ] Kafka Consumer
- [ ] HTTP Controller
- [ ] DTO ë³€í™˜
- [ ] í†µí•© í…ŒìŠ¤íŠ¸

## ğŸš€ ë°°í¬ ì „ëµ

### ê°œë°œ í™˜ê²½
- ë¡œì»¬ ê°œë°œ: H2 Database
- í…ŒìŠ¤íŠ¸: TestContainers í™œìš©

### ìš´ì˜ í™˜ê²½
- MySQL Database
- Kafka Cluster
- ì™¸ë¶€ API ì—°ë™

## ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸

### Domain Layer
- [ ] Delivery Aggregate Root êµ¬í˜„
- [ ] Value Objects ë¶ˆë³€ì„± ë³´ì¥
- [ ] Domain Service ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
- [ ] Repository Port ì¸í„°í˜ì´ìŠ¤

### Application Layer
- [ ] Facade íë¦„ ì¡°ì •
- [ ] Domain Service í˜¸ì¶œ

### Infrastructure Layer
- [ ] JPA Entity ë§¤í•‘
- [ ] Repository Adapter êµ¬í˜„
- [ ] ì™¸ë¶€ API Adapter (ë”ë¯¸)
- [ ] Kafka Consumer êµ¬í˜„

### Interface Layer
- [ ] HTTP Controller
- [ ] Request/Response DTO
- [ ] ì˜ˆì™¸ ì²˜ë¦¬

## ğŸ” í–¥í›„ ê°œì„ ì‚¬í•­

1. **ì‹¤ì œ ì™¸ë¶€ API ì—°ë™**: ë”ë¯¸ êµ¬í˜„ì²´ë¥¼ ì‹¤ì œ APIë¡œ êµì²´
2. **ì¹´í”„ì¹´ ì´ë²¤íŠ¸ êµ¬ì¡°**: êµ¬ì²´ì ì¸ ì´ë²¤íŠ¸ ìŠ¤í‚¤ë§ˆ ì •ì˜
3. **ì•ˆì‹¬ë²ˆí˜¸ ê´€ë¦¬**: í†µì‹ ì‚¬ API ì—°ë™
4. **ëª¨ë‹ˆí„°ë§**: ë°°ì†¡ ìƒíƒœ ì¶”ì  ëŒ€ì‹œë³´ë“œ
5. **ì„±ëŠ¥ ìµœì í™”**: ëŒ€ìš©ëŸ‰ íŠ¸ëœì­ì…˜ ì²˜ë¦¬

---

**ì‘ì„±ì¼**: 2025-01-12  
**ì‘ì„±ì**: ê°œë°œíŒ€  
**ë²„ì „**: 1.0
