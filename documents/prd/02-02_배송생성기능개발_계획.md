# 배송 생성 기능 개발 계획

## 📋 요구사항 분석

### 배경
- 배차서버에서 발행한 카프카 이벤트를 수신해서 배송을 시작하는 기능 개발
- 카프카 이벤트 정보는 아직 미정이므로 더미로 구현 후 추후 구체화

### 핵심 기능
1. **카프카 이벤트 수신**: `dispatch.event` 토픽에서 배차 완료 이벤트 수신
2. **배송 생성**: 수신한 이벤트로 배송(Delivery) 생성
3. **안심번호 생성**: 통신사 호출하여 안심번호 생성 (현재는 더미 구현)
4. **배송 정책 조회**: 주문 서버 호출하여 배송 정책 조회 (현재는 더미 구현)

## 🏗️ 아키텍처 설계

### 레이어별 책임
```
Kafka Consumer (Interface Layer)
  → DeliveryFacade (Application Layer)
    → DeliveryCreator (Domain Service)
      → DeliveryRepository (Port)
        → DeliveryRepositoryAdapter (Infrastructure Layer)
```

### 도메인 모델
- **Delivery**: 배송 Aggregate Root
- **DeliveryNumber**: 배송번호 (DEL-YYMMDDHHMMSS + 랜덤 3자리)
- **DeliveryStatus**: 배송상태 (STARTED, ARRIVED, PICKED_UP, COMPLETED, CANCELLED)
- **DeliverySafePhoneNumber**: 안심번호
- **DeliveryStatusHistory**: 상태 이력
- **DeliveryPhoto**: 배송 사진
- **DeliveryPolicy**: 배송 정책

## 📁 생성할 파일

### Domain Layer (core/domain/delivery/)
```
core/domain/delivery/
├── Delivery.java                          # Aggregate Root
├── DeliveryNumber.java                    # Value Object
├── DeliveryStatus.java                    # Enum
├── DeliveryCreator.java                   # Domain Service (생성)
├── DeliveryReader.java                    # Domain Service (조회)
├── CreateDeliveryCommand.java             # Command
├── DeliveryCreatedEvent.java              # Domain Event
├── exception/
│   ├── DeliveryNotFoundException.java
│   └── InvalidDeliveryException.java
└── required/
    └── DeliveryRepository.java            # Port
```

### Application Layer (core/application/delivery/)
```
core/application/delivery/
└── DeliveryFacade.java                    # Facade
```

### Infrastructure Layer (infrastructure/)
```
infrastructure/
├── storage/db/delivery/
│   ├── entity/
│   │   ├── DeliveryEntity.java
│   │   ├── DeliverySafePhoneNumberEntity.java
│   │   ├── DeliveryStatusHistoryEntity.java
│   │   ├── DeliveryPhotoEntity.java
│   │   └── DeliveryPolicyEntity.java
│   └── adapter/
│       └── DeliveryRepositoryAdapter.java
├── external/
│   ├── client/
│   │   ├── AgentFeignClient.java          # 기사 서버 (더미)
│   │   └── OrderFeignClient.java          # 주문 서버 (더미)
│   └── adapter/
│       ├── AgentAdapter.java              # 더미
│       └── OrderAdapter.java              # 더미
└── messaging/
    └── consumer/
        └── DispatchCompletedEventConsumer.java  # Kafka Consumer
```

### Interface Layer (api/)
```
api/web/delivery/
├── DeliveryController.java
└── dto/
    ├── request/
    │   └── CreateDeliveryRequest.java
    └── response/
        └── DeliveryResponse.java
```

## 🔧 작업 내용

### 1단계: Domain Layer 구현
- **Delivery Aggregate Root**: 핵심 비즈니스 로직
- **Value Objects**: DeliveryNumber, DeliveryStatus
- **Domain Services**: DeliveryCreator, DeliveryReader
- **Commands & Events**: CreateDeliveryCommand, DeliveryCreatedEvent
- **Ports**: DeliveryRepository 인터페이스

### 2단계: Application Layer 구현
- **DeliveryFacade**: 흐름 조정 (Domain Service 호출)

### 3단계: Infrastructure Layer 구현
- **JPA Entity**: Domain ↔ Entity 매핑
- **Repository Adapter**: DeliveryRepository 구현
- **외부 API Adapter**: 기사 서버, 주문 서버 (더미)
- **Kafka Consumer**: dispatch.event 토픽 수신

### 4단계: Interface Layer 구현
- **Controller**: HTTP API
- **DTO**: Request/Response 변환

## 🎯 핵심 비즈니스 로직

### 배송 생성 흐름
1. **카프카 이벤트 수신**: `dispatch.event` 토픽에서 배차 완료 이벤트 수신
2. **배송 정책 조회**: 주문 서버 호출 (더미)
3. **기사 정보 조회**: 기사 서버 호출 (더미)
4. **안심번호 생성**: 통신사 호출 (더미)
5. **배송 생성**: Delivery Aggregate 생성
6. **상태 이력 기록**: STARTED 상태로 초기화
7. **도메인 이벤트 발행**: DeliveryCreatedEvent

### 배송번호 생성 규칙
- **형식**: `DEL-YYMMDDHHMMSS` + 랜덤 3자리
- **예시**: `DEL-250112143000123`

### 상태 전이
```
정상 진행:
STARTED → ARRIVED → PICKED_UP → COMPLETED

취소:
STARTED → CANCELLED
ARRIVED → CANCELLED
```

## 🔄 외부 시스템 연동 (더미)

### 기사 서버 API (더미)
```java
// TODO: 실제 기사 서버 API 연동
// GET /api/v1/agents/{agentId}
// Response: { agentId, phoneNumber, name }
```

### 주문 서버 API (더미)
```java
// TODO: 실제 주문 서버 API 연동
// GET /api/v1/orders/{orderId}/delivery-policy
// Response: { alcoholDelivery, contactlessDelivery, pickupRequestTime }
```

### 통신사 API (더미)
```java
// TODO: 실제 통신사 API 연동
// POST /api/v1/safe-phone-numbers
// Request: { originalPhoneNumber }
// Response: { safePhoneNumber, expiresAt }
```

## 📊 데이터베이스 설계

### 주요 테이블
- **DELIVERY**: 배송 메인 정보
- **DELIVERY_SAFE_PHONE_NUMBER**: 안심번호 관리
- **DELIVERY_STATUS_HISTORY**: 상태 변경 이력
- **DELIVERY_PHOTO**: 배송 사진
- **DELIVERY_POLICY**: 배송 정책

### 인덱스 전략
- `delivery_number` (UNIQUE)
- `order_id` (조회용)
- `agent_id` (조회용)
- `status` (상태별 조회)

## 🧪 테스트 전략

### 단위 테스트
- **Domain Layer**: 순수 Java 테스트 (Spring Context 없음)
- **Application Layer**: Mock을 활용한 UseCase 테스트
- **Infrastructure Layer**: @DataJpaTest 활용
- **Interface Layer**: @WebMvcTest 활용

### 통합 테스트
- **Kafka Consumer**: 실제 카프카 연동 테스트
- **외부 API**: WireMock 활용한 API 모킹

## 📝 구현 순서

### 1주차: Domain Layer
- [ ] Delivery Aggregate Root
- [ ] Value Objects
- [ ] Domain Services
- [ ] Commands & Events
- [ ] Repository Port

### 2주차: Application & Infrastructure
- [ ] DeliveryFacade
- [ ] JPA Entity 매핑
- [ ] Repository Adapter
- [ ] 외부 API Adapter (더미)

### 3주차: Interface & Integration
- [ ] Kafka Consumer
- [ ] HTTP Controller
- [ ] DTO 변환
- [ ] 통합 테스트

## 🚀 배포 전략

### 개발 환경
- 로컬 개발: H2 Database
- 테스트: TestContainers 활용

### 운영 환경
- MySQL Database
- Kafka Cluster
- 외부 API 연동

## 📋 체크리스트

### Domain Layer
- [ ] Delivery Aggregate Root 구현
- [ ] Value Objects 불변성 보장
- [ ] Domain Service 비즈니스 로직
- [ ] Repository Port 인터페이스

### Application Layer
- [ ] Facade 흐름 조정
- [ ] Domain Service 호출

### Infrastructure Layer
- [ ] JPA Entity 매핑
- [ ] Repository Adapter 구현
- [ ] 외부 API Adapter (더미)
- [ ] Kafka Consumer 구현

### Interface Layer
- [ ] HTTP Controller
- [ ] Request/Response DTO
- [ ] 예외 처리

## 🔍 향후 개선사항

1. **실제 외부 API 연동**: 더미 구현체를 실제 API로 교체
2. **카프카 이벤트 구조**: 구체적인 이벤트 스키마 정의
3. **안심번호 관리**: 통신사 API 연동
4. **모니터링**: 배송 상태 추적 대시보드
5. **성능 최적화**: 대용량 트랜잭션 처리

---

**작성일**: 2025-01-12  
**작성자**: 개발팀  
**버전**: 1.0
